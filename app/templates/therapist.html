<!DOCTYPE html>
<html>
<head>
    <title>Therapist Dashboard - {{ therapist[1] }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat { font-size: 2em; font-weight: bold; color: #f5576c; }
        .leaderboard { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
        .sql-box { background: #2d3748; color: #68d391; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 11px; overflow-x: auto; display: none; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; line-height: 1.5; }
        .sql-keyword { color: #ff79c6; font-weight: bold; }
        .sql-function { color: #8be9fd; font-weight: bold; }
        .sql-comment { color: #6272a4; font-style: italic; }
        button { background: #f5576c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        .back { display: inline-block; margin-bottom: 20px; color: #f5576c; text-decoration: none; font-weight: bold; }
        .leader { background: #ffd700; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .bonus-achieved { background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; }
        .bonus-pending { background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5576c; color: white; }
        tr:hover { background: #f9f9f9; }
        .time-display { font-family: monospace; color: #555; }
        .jobs-section { grid-column: span 2; }
        .no-jobs { color: #999; font-style: italic; padding: 20px; text-align: center; }
        .window-function-badge { background: #bd93f9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .gap-positive { color: #50fa7b; font-weight: bold; }
        .gap-negative { color: #ff5555; font-weight: bold; }
        .rank-display { font-size: 3em; font-weight: bold; text-align: center; margin: 10px 0; }
        .rank-suffix { font-size: 0.5em; vertical-align: super; }
        .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .metric-label { opacity: 0.9; }
        .metric-value { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back">‚Üê Back to Login</a>
        
        <div class="header">
            <h1>Welcome, {{ therapist[1] }}</h1>
            <p>Role: {{ therapist[3] }} | Started: {{ therapist[2] }}</p>
        </div>
        
        <div class="grid">
            <!-- Jobs Today -->
            <div class="card jobs-section">
                <h3>üìÖ Jobs Today ({{ jobs_today|length }})</h3>
                {% if jobs_today %}
                <table>
                    <tr>
                        <th>Time</th>
                        <th>Service</th>
                        <th>Customer</th>
                        <th>CID</th>
                        <th>Duration</th>
                        <th>Revenue</th>
                    </tr>
                    {% for job in jobs_today %}
                    <tr>
                        <td class="time-display">
                            {{ job[2].strftime('%H:%M') }} - {{ job[3].strftime('%H:%M') }}
                        </td>
                        <td>{{ job[0] }}</td>
                        <td>{{ job[5] }}</td>
                        <td>#{{ job[4] }}</td>
                        <td>
                            {% if job[2] and job[3] %}
                                {{ ((job[3] - job[2]).total_seconds() / 60)|int }} min
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(job[1]) }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p class="no-jobs">No completed jobs today.</p>
                {% endif %}
            </div>
            
            <!-- Jobs Yesterday -->
            <div class="card jobs-section">
                <h3>üìÜ Jobs Yesterday ({{ jobs_yesterday|length }})</h3>
                {% if jobs_yesterday %}
                <table>
                    <tr>
                        <th>Time</th>
                        <th>Service</th>
                        <th>Customer</th>
                        <th>CID</th>
                        <th>Duration</th>
                        <th>Revenue</th>
                    </tr>
                    {% for job in jobs_yesterday %}
                    <tr>
                        <td class="time-display">
                            {{ job[2].strftime('%H:%M') }} - {{ job[3].strftime('%H:%M') }}
                        </td>
                        <td>{{ job[0] }}</td>
                        <td>{{ job[5] }}</td>
                        <td>#{{ job[4] }}</td>
                        <td>
                            {% if job[2] and job[3] %}
                                {{ ((job[3] - job[2]).total_seconds() / 60)|int }} min
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(job[1]) }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p class="no-jobs">No completed jobs yesterday.</p>
                {% endif %}
            </div>
            
            <!-- Stats Cards -->
            <div class="card">
                <h3>üìä Today Summary</h3>
                <p class="stat">{{ stats.today[0] }}</p>
                <p>Services</p>
                <p class="stat">${{ "%.2f"|format(stats.today[1]) }}</p>
                <p>Revenue</p>
            </div>
            
            <div class="card">
                <h3>üìà This Week</h3>
                <p class="stat">{{ stats.week[0] }}</p>
                <p>Services</p>
                <p class="stat">${{ "%.2f"|format(stats.week[1]) }}</p>
                <p>Revenue</p>
            </div>
            
            <div class="card">
                <h3>üìà This Month</h3>
                <p class="stat">{{ stats.month[0] }}</p>
                <p>Services</p>
                <p class="stat">${{ "%.2f"|format(stats.month[1]) }}</p>
                <p>Revenue</p>
            </div>
            
            <div class="card">
                <h3>üóìÔ∏è Year to Date</h3>
                <p class="stat">{{ stats.ytd[0] }}</p>
                <p>Services</p>
                <p class="stat">${{ "%.2f"|format(stats.ytd[1]) }}</p>
                <p>Revenue</p>
            </div>
            
            <!-- ============================================ -->
            <!-- REAL WINDOW FUNCTION LEADERBOARD -->
            <!-- ============================================ -->
            <div class="card leaderboard" style="grid-column: span 2;">
                <span class="window-function-badge">üî• SQL WINDOW FUNCTION</span>
                <h3>üèÜ Monthly Leaderboard Status</h3>
                
                {% if leaderboard.rank > 0 %}
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 15px;">
                    <!-- Left: Big Rank Display -->
                    <div style="text-align: center; border-right: 2px solid rgba(255,255,255,0.3); padding-right: 20px;">
                        <div class="rank-display">
                            {{ leaderboard.rank }}<span class="rank-suffix">
                                {% if leaderboard.rank == 1 %}st{% elif leaderboard.rank == 2 %}nd{% elif leaderboard.rank == 3 %}rd{% else %}th{% endif %}
                            </span>
                        </div>
                        <p>of {{ leaderboard.total_therapists }} therapists</p>
                        {% if leaderboard.is_leader %}
                        <span class="leader">üëë LEADER</span>
                        {% endif %}
                    </div>
                    
                    <!-- Right: Detailed Metrics -->
                    <div>
                        <div class="metric-row">
                            <span class="metric-label">Monthly Revenue:</span>
                            <span class="metric-value">${{ "%.2f"|format(leaderboard.revenue) }}</span>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Leader's Revenue:</span>
                            <span class="metric-value">${{ "%.2f"|format(leaderboard.leader_revenue) }}</span>
                        </div>
                        
                        <div class="metric-row">
                            <span class="metric-label">Gap to Leader:</span>
                            <span class="metric-value {% if leaderboard.gap_to_leader > 0 %}gap-negative{% else %}gap-positive{% endif %}">
                                {% if leaderboard.is_leader %}
                                ‚Äî (You're #1!)
                                {% else %}
                                ${{ "%.2f"|format(leaderboard.gap_to_leader) }}
                                {% endif %}
                            </span>
                        </div>
                        
                        {% if not leaderboard.is_leader and leaderboard.person_above_revenue %}
                        <div class="metric-row">
                            <span class="metric-label">Person Above You:</span>
                            <span class="metric-value">${{ "%.2f"|format(leaderboard.person_above_revenue) }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Gap to Next Rank:</span>
                            <span class="metric-value gap-positive">${{ "%.2f"|format(leaderboard.gap_from_above) }} ahead</span>
                        </div>
                        {% endif %}
                        
                        {% if leaderboard.person_below_revenue %}
                        <div class="metric-row">
                            <span class="metric-label">Person Below You:</span>
                            <span class="metric-value">${{ "%.2f"|format(leaderboard.person_below_revenue) }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Lead Over Next:</span>
                            <span class="metric-value gap-positive">${{ "%.2f"|format(leaderboard.gap_to_next) }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="metric-row" style="border-top: 2px solid rgba(255,255,255,0.3); margin-top: 10px; padding-top: 10px;">
                            <span class="metric-label">Bonus Status ($8,000):</span>
                            <span class="metric-value">
                                {% if 'Achieved' in leaderboard.bonus_status %}
                                <span class="bonus-achieved">{{ leaderboard.bonus_status }}</span>
                                {% else %}
                                <span class="bonus-pending">{{ leaderboard.bonus_status }}</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                {% else %}
                <p>No leaderboard data available.</p>
                {% endif %}
                
                <button onclick="toggleSQL('sql-window')" style="background: white; color: #f5576c; margin-top: 15px;">
                    Show Window Function SQL
                </button>
                <div id="sql-window" class="sql-box" style="margin-top: 10px;">
                    <span class="sql-comment">-- SQL Window Functions: RANK, LAG, LEAD, FIRST_VALUE</span>
                    {{ window_sql | safe }}
                </div>
            </div>
            
            <!-- Top 5 Customers -->
            <div class="card" style="grid-column: span 2;">
                <h3>üë• Top 5 Customers (All Time)</h3>
                {% if top_customers %}
                <table>
                    <tr>
                        <th>CID</th>
                        <th>Customer</th>
                        <th>Total Spend</th>
                        <th>Visits</th>
                        <th>Last Visit</th>
                        <th>Avg $/Visit</th>
                        <th>Avg Time/Visit</th>
                    </tr>
                    {% for customer in top_customers %}
                    <tr>
                        <td>#{{ customer[0] }}</td>
                        <td>{{ customer[1] }}</td>
                        <td>${{ "%.2f"|format(customer[2]) }}</td>
                        <td>{{ customer[3] }}</td>
                        <td>
                            {% if customer[4] %}
                                {{ customer[4].strftime('%Y-%m-%d') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(customer[5]) }}</td>
                        <td>{{ "%.0f"|format(customer[6]) }} min</td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p>No customer history found.</p>
                {% endif %}
                <button onclick="toggleSQL('sql-customers')" style="margin-top: 10px;">Show SQL</button>
                <div id="sql-customers" class="sql-box" style="display: none;">{{ top_customers_sql }}</div>
            </div>
        </div>
    </div>
    
    <script>
        function toggleSQL(id) {
            var el = document.getElementById(id);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>